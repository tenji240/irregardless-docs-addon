<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
<!-- The CSS package above applies Google styling to buttons and other elements. -->

<style>
  .clearfix:before, .clearfix:after{
    content: " ";
    display: table;
  }
  .clearfix:after {
    clear: both
  }
  .muted {
    color: #6d6d6d;
  }
  ul {
    text-align: left;
    padding-left: 20px;
    list-style: initial;
  }
  .unstyled {
    list-style: none;
    padding-left: 0;
    text-align: center;
  }
  .settings {
    display: none;
    margin-bottom: 12px;
  }
  .styleguide-list {
    list-style: none;
    cursor: pointer;
    width: 200px;
    color: #6d6d6d;
    padding: 0;
    margin: 0;
  }
  .styleguide-list > li {
    padding: 8px 0 8px 6px;
    border: 1px dotted #f4b4b4;
  }
  .chosen-guide {
    background-color: #da2020;
    color: #f8f8f8;
  }
  .styleguide-list > li:hover {
    background-color: #da2020;
    color: #f8f8f8;
  }
  .sidebar {
    position: static;
  }
  .notice {
    display: none;
    margin: 0 auto;
    padding-top: 30px;
    text-align: center;
    font-size: 1.2em;
    color: #aaa;
  }
  #error {
    display: none;
  }
  #no-results {
    display: none;
  }
  .logo {
    vertical-align: middle;
  }
  .sidebar {
    padding: 0;
  }
  .footer {
    position: fixed;
    width: 100%;
    bottom: 0;
    background-color: #f8f8f8;
    padding: 2px 0;
    border-top: 1px solid #aaa;
  }
  .tips-container {
    padding: 0 12px;
  }
  .tip-container {
    max-height: auto;
    padding: 15px 0;
    border-bottom: 1px solid #d9d9d9;
  }
  .replacements {
    width: 80%;
    margin: 0 auto;
  }
  .creator {
    text-align: right;
    padding-right: 10px;
  }
  .match-content {
    padding: 2px 4px;
    border: solid 2px #da2020;
    border-radius: 5px;
    color: #da2020
  }
  .text-snippet {
    color: #6d6d6d;
    padding: 8px;
    text-align: left;
  }
  .explanation {
    text-align: left;
    margin: 8px 4px;
  }
  .tips-list {
    margin-top: 0;
  }
  .match-string {
    font-weight: bold;
  }
  .tip {
    border-radius: 4px;
    border: 1px dotted #f4b4b4;
    padding: 10px 5px;
    margin: 4px 8px;
    background-color: #f8f8f8;
  }
</style>

<div class="addon">
  <div class="sidebar">
    <div class="settings-trigger" data-toggle-settings>
      settings
    </div>
    <div class="settings">
      <ul class="unstyled styleguide-list">
      </ul>
      <div class="spinner">
      </div>
    </div>
    <div id="notice" class="notice">
    </div>
    <div class="tips-container">
      <ul class="tips-list unstyled">
      </ul>
    </div>
  </div>

  <!-- <div class="footer">
    <img alt="Add-on logo" class="logo" width="27" height="27"
        src="http://irregardless.ly/assets/favicon.png">
    <span class="gray branding-text">Writing Tips by <a href="http://irregardless.ly" target="_blank">Irregardless</a></span>
  </div> -->
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">
</script>

<script>

    var $notice = $("#notice"),
        $styleGuideList = $(".styleguide-list");

    $(function() {
      getTips();
      getGuides();
      $("[data-toggle-settings]").on("click", function(){
        var $settings = $('.settings');
        if($settings.is(":visible")){
          $settings.hide();
        } else {
          $settings.show();
        }
      });
    });

   function getGuides(){
      google.script.run
          .withSuccessHandler(
            function(resp) {
              renderGuides(resp);
              console.log("success");
            })
          .withFailureHandler(
            function() {
              console.log("error");
            })
          .getGuides(tip);
   }

   function highlight(tip){
      google.script.run
          .withSuccessHandler(
            function() {
              console.log("success");
            })
          .withFailureHandler(
            function() {
              console.log("error");
            })
          .highlight(tip);
   }

   function renderGuides(resp){
     var guides = resp.guides,
         selectedGuideId = resp.chosenGuideId || 1, //1 is the "Everything" guide.
         chosenGuideHtml;

     $styleGuideList.empty();
     for(var i=0; i<guides.length; i++){
       var guide = guides[i],
           html;
       if(guide.id === selectedGuideId){
         chosenGuideHtml = "<li class=\"chosen-guide\" data-save-guide-id=" +
                    guide.id + "><span class=\"check\">&#x2713;</span> " +
                    guide.name +
                  "</li>";
       } else {
         html = "<li data-save-guide-id=" + guide.id + ">" +  guide.name + "</li>";
         $styleGuideList.append(html);
       }
     }
     $styleGuideList.prepend(chosenGuideHtml);
   }

  //either build an <ul> or return Don't use
  function replacementHtml(tip){
    var html = "<div class=\"replacements\">";
    if(tip.replacements && tip.replacements.length){
      html += "<span class=\"muted\">Instead Try:</span><ul>";
      for(var i=0; i<tip.replacements.length; i++){
        html += "<li>" + tip.replacements[i] + "</li>";
      }
      html += "</ul>";
    } else {
     html += "<span class=\"muted\"> Don't Use </span>";
    }
    return html + "</div>";
  }

  function tipToHtml(tip){
    var beginning = "<li class=\"tip-container\">"+
      "<div class=\"text-snippet\">"+
        tip.text_snippet +
      "</div>"+
      "<div class=\"tip clearfix\">"+
        "<div class=\"match-string\">"+
          tip.matched_string +
        "</div>"+
        "<div class=\"explanation\">"+
          tip.explanation +
        "</div>";

      var end = "</div>"+
                "<div class=\"creator\">"+
                "<a href='http://irregardless.ly/#!/profile/" + tip.creator_id + "' target='_blank'>"+
                  tip.creator_name+
                "</a>"+
            "</div>"+
          "</li>";

    return beginning + replacementHtml(tip) + end;
  }

  function showLoading(){
    $notice.html("Loading...").show();
  }

  function showNoResults(){
    $notice.html("No results. <br /> Your writing looks good!").show();
  }

  function showError(){
    $(".tips-list").empty();
    $notice.html("Oops! Something went wrong.<br />Please refresh and try again").show();
  }

  function showNoText(){
    $notice.html("Looks like you don't have any writing in your document.").show();
  }

  function getTips(){
    showLoading()
    google.script.run
        .withSuccessHandler(
          function(resp) {
            if(resp.error === "noText"){
              showNoText();
            } else {
              showTips(resp.fullText, resp.tips);
            }
          })
        .withFailureHandler(
          function(msg, element) {
            showError();
          })
        .withUserObject(this)
        .getTips();
  }

  function showTips(fullText, tips){
    $notice.hide();
    if(tips.length){
      for (var i = 0; i < tips.length; i++) {
        var tip = tips[i],
            _tip = JSON.parse(JSON.stringify(tip));
            _tip.text_snippet = prepareSnippet(fullText, tip);
            var html = tipToHtml(_tip);
             highlight(_tip);
            $('.tips-list').append(html);
      }
    } else {
      showNoResults()
    }
  }

  function prepareSnippet(fullText, tip){
    //match will either be in the tip's `match_string`,
    //or the tips `matched_string`
    var match, snippet, indexOfM;
    if(fullText.indexOf(tip.match_string) !== -1){
      match = tip.match_string;
    } else {
      match = tip.matched_string;
    }
    //if text is short, snippet is the text
    if(fullText.length < 100) {
      snippet = fullText;
    } else {
      indexOfM = fullText.indexOf(match);
      //match is in the first 50 characters
      if(indexOfM < 50){
        snippet = fullText.slice(0, 100) + "...";
      //match is in the last 50 characters
      } else if(fullText.length - indexOfM < 50) {
        snippet = "..." + fullText.slice(fullText.length - 100, fullText.length);
      //match is somewhere in the middle
      } else {
        snippet = "..." + fullText.slice(indexOfM - 40, indexOfM + 40) + "...";
      }
    }

    return snippet.replace(match, "<span class=\"match-content\">" + match +"</span>");
  }

</script>