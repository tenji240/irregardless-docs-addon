<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
<!-- The CSS package above applies Google styling to buttons and other elements. -->

<style>
  *:active, *:focus {
    outline: none;
  }
  .clearfix:before, .clearfix:after{
    content: " ";
    display: table;
  }
  .clearfix:after {
    clear: both
  }
  .muted {
    color: #6d6d6d;
  }
  .centered {
    text-align: center;
  }
  .float-left {
    float: left;
  }
  .float-right {
    float: right;
  }
  ul {
    text-align: left;
    padding-left: 20px;
    list-style: initial;
  }
  .unstyled {
    list-style: none;
    padding-left: 0;
    text-align: center;
  }
  .sidebar {
    padding: 0;
    position: static;
  }
  #cover-bg {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    z-index: 99;
    background: rgba(36, 31, 31, 0.75);
    display: none;
    -moz-opacity: 0;
    -khtml-opacity: 0;
    opacity: 0;
    -moz-transition: all .5s ease;
    -webkit-transition: all .5s ease;
    -o-transition: all .5s ease;
    -ms-transition: all .5s ease;
    transition: all .5s ease;
  }
  .autorun-checkbox {
    padding-top: 10px;
    text-align: center;
  }
  #cover-bg.showing {
    -moz-opacity: 1;
    -khtml-opacity: 1;
    opacity: 1;
  }
  .actions {
    border-bottom: 1px solid #ddd;
    padding: 13px 11px;
    background: #fcfcfc;
    text-align: center;
  }
  .clear-button {
    padding-left: 8px;
    display: inline-block;
  }
  .btn {
    display: inline-block;
    padding: 6px 12px;
    margin: 0 4px;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    cursor: pointer;
    border: 1px solid transparent;
    border-radius: 4px;
    text-decoration: none;
  }
  .btn:hover {
    text-decoration: none;
  }
  .btn-primary {
    background-color: #f26262;
    color: white;
  }
  .btn-secondary {
    border: 1px solid #d9d9d9;
    background-color: #fdfdfd;
    color: #f26262;
  }
  action-button:hover {
    text-decoration: none;
  }
  .arrow {
    font-size: 0.8em;
  }
  .sg-settings-trigger {
    display: inline-block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: #666;
    font-size: 20px;
    float: right;
  }
  .sg-settings-trigger:hover {
    text-decoration: none;
  }
  .sg-settings {
    position: absolute;
    left: 0;
    width: 100%;
    top: 34px;
    z-index: 100;
    display: none;
    margin-bottom: 12px;
    overflow: hidden;
    border-bottom: 1px solid #aaa;
    border-top: 1px solid #aaa;
    background: #f8f8f8;
    -moz-transition: all 0.5s ease;
    -webkit-transition: all 0.5s ease;
    -o-transition: all 0.5s ease;
    -ms-transition: all 0.5s ease;
    transition: all 0.5s ease;
    max-height: 0px
  }
  .sg-settings.showing {
    max-height: 300px;
    overflow-y: scroll;
  }
  #styleguide-query-input {
    margin: 10px;
    width: 92%;
    padding: 10px;
    height: 30px;
  }
  .styleguide-list {
    list-style: none;
    text-align: left;
    cursor: pointer;
    color: #6d6d6d;
    padding: 0;
    margin: 0;
  }
  .styleguide-list > li {
    position: relative;
    padding: 10px 20px 10px 10px;
    border-bottom: 1px solid #eee;
    -webkit-transform: translateZ(0);
    -webkit-backface-visibility: hidden;
  }
  .chosen-guide {
    background-color: #E56B6B;
    color: #f8f8f8;
  }
  .chosen-guide .check {
    position: absolute;
    right: 10px;
    top: 10px;
  }
  .styleguide-list > li:hover {
    background-color: #E56B6B;
    color: #f8f8f8;
  }
  .notice {
    display: none;
    margin: 0 auto;
    padding-top: 30px;
    text-align: center;
    font-size: 1.2em;
    color: #aaa;
  }
  #error {
    display: none;
  }
  #no-results {
    display: none;
  }
  .logo {
    vertical-align: middle;
  }
  .footer {
    position: absolute;
    height: 30px;
    width: 100%;
    bottom: 0;
    z-index: 2;
    background-color: #f8f8f8;
    padding: 2px 0;
    border-top: 1px solid #aaa;
    color: #777;
  }
  .footer a:hover {
    text-decoration: none;
  }
  .brand {
    color: #f26262;
  }
  .tips-container {
    z-index: 1;
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow-y: scroll;
    padding-bottom: 35px;
    box-sizing: border-box;
  }
  .tip-container {
    position: relative;
    border-bottom: 1px solid #ccc;
    padding: 20px;
    background: #FDFAFA;
    -moz-box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -1px 0 rgba(0,0,0,.02);
    -webkit-box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -1px 0 rgba(0,0,0,.02);
    -o-box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -1px 0 rgba(0,0,0,.02);
    -ms-box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -1px 0 rgba(0,0,0,.02);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -1px 0 rgba(0,0,0,.02);
  }
  .tip-container:nth-child(even) {
    background: #fdfdfd;
  }
  .tip-border {
    position: absolute;
    left: 0;
    top: 0;
    width: 0;
    height: 0;
    margin-left: 0;
    border-style: solid;
    border-width: 10px 10px 0 0;
    border-color: #F26262 transparent transparent transparent;
  }
  .replacements {
    text-align:left;
  }
  .replacements-label {
    color: #F26262;
    display: inline-block;
    margin-bottom: 5px;
    text-transform: uppercase;
  }
  .replacements ul {
    color: #464141;
    list-style: none;
    padding-left: 0;
  }
  .replacements li {
    position: relative;
    padding-left: 10px;
  }
  .replacements li:before {
    position: absolute;
    left: 0;
    top: 0;
    content: "â€¢ ";
    color: #d1d1d1;
    -moz-box-shadow: 0 1px 0 rgba(255,255,255,.3);
    -webkit-box-shadow: 0 1px 0 rgba(255,255,255,.3);
    -o-box-shadow: 0 1px 0 rgba(255,255,255,.3);
    -ms-box-shadow: 0 1px 0 rgba(255,255,255,.3);
    box-shadow: 0 1px 0 rgba(255,255,255,.3);
  }
  .match-content {
    padding: 2px 0px;
    border-bottom: solid 2px #da2020;
    color: #da2020;
  }
  .text-snippet {
    padding-right: 50px;
    margin-bottom: 15px;
    text-align: left;
    color: #6F6E6E;
    min-height: 35px;
    font-size: 14px;
  }
  .explanation {
    text-align: left;
    padding: 10px;
    background: white;
    margin-top: 10px;
    color: #776D6D;
    border: 1px dotted #ccc;
    -moz-border-radius: 4px;
    -webkit-border-radius: 4px;
    border-radius: 4px;
  }
  .tips-list {
    position: relative;
    z-index: 1;
    margin-top: 0;
    margin-bottom: 0;
  }
  .match-string {
    font-weight: bold;
  }
  .tip {
  }
  .creator {
    position: absolute;
    width: 40px;
    right: 0;
    top: 0;
    padding: 0;
  }
  .creator img {
    width: 35px;
    height: 35px;
    -moz-box-shadow: -1px 1px 1px rgba(0 , 0 , 0 , 0.3);
    -webkit-box-shadow: -1px 1px 1px rgba(0 , 0 , 0 , 0.3);
    -o-box-shadow: -1px 1px 1px rgba(0 , 0 , 0 , 0.3);
    -ms-box-shadow: -1px 1px 1px rgba(0 , 0 , 0 , 0.3);
    box-shadow: -1px 1px 1px rgba(0 , 0 , 0 , 0.3);
  }
  .creator p {
    margin: 0;
    text-align: center;
  }
</style>

<div class="addon">
  <div class="sidebar">
    <div class="tips-container">
      <div class="actions clearfix">
        <a href="javascript://" class="btn btn-primary" data-get-tips>Get Tips</a>
        <a href="javascript://" class="btn btn-secondary clear-button" data-clear-highlights>clear</a>
        <a id="sg-settings-trigger" class="sg-settings-trigger" data-toggle-sg-settings>
          &#x2699;
        </a>
      </div>
      <div class="sg-settings">
        <div class="autorun-checkbox">
          <input type="checkbox" id="toggle-autorun"/> Auto-run<br />
        </div>
        <input type="text" id="styleguide-query-input" placeholder="Search for a styleguide" />
        <ul class="unstyled styleguide-list">
        </ul>
        <div class="spinner">
        </div>
      </div>
      <div id="notice" class="notice">
      </div>
      <ul class="tips-list unstyled">
      </ul>
      <div id="cover-bg" data-close-active-settings>
      </div>
    </div>
    <div class="footer">
      <a href="http://irregardless.ly" target="_blank">
        <img alt="Add-on logo" class="logo" width="27" height="27" src="http://irregardless.ly/assets/favicon.png" />
        Writing Tips by <span class="brand">Irregardless</span>
      </a>
    </div>
  </div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">
</script>

<script>

/***********************  Global Helpers  **************************/
var throttle = (function(){
  var timer = 0;
  return function(callback, ms){
    clearTimeout (timer);
    timer = setTimeout(callback, ms);
  };
})();


/***********************  Tip Rendering  **************************/

var Tip = function(tip, fullText) { 
  tip.text_snippet = this.prepareSnippet(fullText, tip);
  this.tip = tip; 
};
//either build an <ul> or return Don't use
Tip.prototype.replacementHtml = function (){
  var html = "<div class=\"replacements\">";
  if(this.tip.replacements && this.tip.replacements.length){
    html += "<div class=\"muted replacements-label\">Instead Try:</div><ul>";
    for(var i=0; i < this.tip.replacements.length; i++){
      html += "<li>" + " <a title=\"Click to apply\" href=\"javascript://\" data-replacement=\"" + this.tip.replacements[i] + "\" data-apply-tip>" + this.tip.replacements[i] + "</a>" + "</li>";
    }
    html += "</ul>";
  } else {
   html += "<div class=\"muted replacements-label\"> Don't Use </div>";
  }
  return html + "</div>";
}

Tip.prototype.linkify = function (string) {
  var urlRegex = /(https?:\/\/[^\s]+)/g;
  if(!string) return;
  return string.replace(urlRegex, function(url) {
    return '<a target="_blank" href="' + url + '">' + url + '</a>';
  });
}

Tip.prototype.truncate = function (string, length){
  if(string.length <= length) return string;
  else return string.substring(0, length) + "...";
}

Tip.prototype.render = function (){
  var beginning = "<li class=\"tip-container\">"+
    "<div class=\"creator\">"+
      "<a href='http://irregardless.ly/#!/profile/" + this.tip.creator.id + "' target='_blank'>"+
        "<img src=\""+ this.tip.creator.mugshot_url+"\" title=\""+ this.tip.creator.name.split(' ')[0] + "\" alt=\""+ this.tip.creator.name.split(' ')[0] + "\" />"+
      "</a>"+
    "</div>"+
    "<div class=\"text-snippet\">"+
      this.tip.text_snippet +
    "</div>"+
    "<div class=\"tip clearfix\">"+
      this.replacementHtml() +
      "<div class=\"explanation\">"+
        this.linkify(this.truncate(this.tip.explanation, 230)) +
        "<a href=\"http://irregardless.ly/#!/tip/" + this.tip.id + "\" target=\"_blank\" class=\"more-link\">more</a>" +
      "</div>" +
      "<div class='tip-border'></div>";

    var end = "</div>"+
        "</li>";
    var $el = $(beginning + end);
    $el.data('tipObject', this.tip);
  return $el;
}

Tip.prototype.prepareSnippet = function(fullText, tip){
  //match will either be in the tip's `match_string`,
  //or the tips `matched_string`
  var match, snippet, indexOfM;
  if(fullText.indexOf(tip.match_string) !== -1){
    match = tip.match_string;
  } else {
    match = tip.matched_string;
  }
  //if text is short, snippet is the text
  if(fullText.length < 100) {
    snippet = fullText;
  } else {
    indexOfM = fullText.indexOf(match);
    //match is in the first 50 characters
    if(indexOfM < 50){
      snippet = fullText.slice(0, 100) + "...";
    //match is in the last 50 characters
    } else if(fullText.length - indexOfM < 50) {
      snippet = fullText.slice(fullText.length - 100, fullText.length);
    //match is somewhere in the middle
    } else {
     snippet = fullText.slice(indexOfM - 40, indexOfM + 40) + "...";
    }
  }
  return snippet.replace(match, "<span class=\"match-content\">" + match +"</span>");
}


/***********************  Sidebar control functions  **************************/

var SideBarObj = function() {
   var $notice = $("#notice"),
        $tipsList = $('.tips-list'),
        $styleGuideList = $(".styleguide-list"),
        $sgSettings = $('.sg-settings'),
        $sgSettingsTrigger = $("#settings-trigger"),
        $autoRunCheckBox = $("#toggle-autorun"),
        $coverBG = $('#cover-bg');
 
   // Could be further extracted
   this.renderGuides = function(guides) {
     var guides = guides || Irregardless.guides,
         chosenGuideHtml;
     $styleGuideList.empty();
     if(guides.length) {
       for(var i=0; i<guides.length; i++){
         var guide = guides[i],
             html;
         if(guide.id === Irregardless.selectedGuideId){
           chosenGuideHtml = "<li class=\"chosen-guide\" data-save-guide-name=\"" + guide.name + "\" data-save-guide-id=" +
                      guide.id + " data-toggle-settings ><span class=\"check\">&#x2713;</span> " +
                      guide.name +
                    "</li>";
           $sgSettingsTrigger.show();
         } else {
           html = "<li data-save-guide-id=" + guide.id + " data-save-guide-name=\"" + guide.name + "\" data-toggle-settings>" +  guide.name + "</li>";
           $styleGuideList.append(html);
         }
       }
       $styleGuideList.prepend(chosenGuideHtml);
     } else {
       $styleGuideList.append("<li class='muted centered'> No results...</li>");
     }
   }
   
   
   this.showTips = function(fullText, tips){
     $notice.hide();
     if(tips.length){
       for (var i = 0; i < tips.length; i++) {
         var tip = tips[i];
         GoogleInterface.highlight(tip);
         //`tip` is immuteable, make a muteable copy to add
         //the property `text_snippet` to
         var _tip = JSON.parse(JSON.stringify(tip));
         var html = new Tip(_tip, fullText).render();
         $tipsList.append(html);
      }
    } else {
      this.showNoResults()
    }
  }

  this.closeActiveSettings = function(){
    var $settingsEl;
    if($sgSettings.is(":visible")){
      $settingsEl = $sgSettings;
    }
    $settingsEl.removeClass('showing');
    $coverBG.removeClass('showing');
    setTimeout(function(){
      $settingsEl.hide();
      $coverBG.hide();
    },500);
  }
  
  this.showSgSettings = function() {
    $sgSettings.show();
    $coverBG.show();
    $autoRunCheckBox.prop('checked', Irregardless.isAutoRunEnabled);
    setTimeout(function(){
      $sgSettings.addClass('showing');
      $coverBG.addClass('showing');
    },0);
  }
  
  this.clearTips = function() {
    $tipsList.empty();
  }
  
  this.showLoading = function () {
    $notice.html("Loading...").show();
  }
  
  this.showLoadingGuides = function () {
    $styleGuideList.empty();
    $styleGuideList.append("<li class='centered muted'>Loading...</li>");
  }

  this.showNoResults = function(){
    $notice.html("No results. <br /> Your writing looks good!").show();
  }

  this.showError = function(){
    $(".tips-list").empty();
    $notice.html("Oops! Something went wrong.<br />Please refresh and try again").show();
  }

  this.showNoText = function (){
    $notice.html("Looks like you don't have any writing in your document.").show();
  }
  
  this.showInstructions = function (){
    $notice.html("Click 'Get Tips' to check your writing.").show();
  }
}

var SideBar;
$(function() { SideBar = new SideBarObj(); }); // Init on DOM ready

    
var GoogleInterface = new function() {
  var noOp = function() {};
  var matches;
  
  var matchForTip = function(tip) {
    return $.grep(matches, function(match) { return match.text == tip.matched_string; })[0];
  }
  
  this.highlight = function(tip) {
    matches = [];
    google.script.run
        .withSuccessHandler(function(highlightedMatches) { matches = matches.concat(highlightedMatches); })
        .withFailureHandler(
          function() {
            SideBar.showError();
          })
        .highlight(tip);
  }
   
  this.removeHighlights = function () {
    google.script.run
        .withSuccessHandler(function() { })
        .withFailureHandler(
          function() { SideBar.showError(); })
        .unHighlight(matches);
  }

  this.applyTip = function(tip, replace) {
    var tipMatch = matchForTip(tip);
    google.script.run
        .withSuccessHandler(
          function() {
            matches = $.grep(matches, function(match) { return match.text != tip.matched_string; });
          })
        .withFailureHandler(
          function() {
            SideBar.showError();
          })
        .applyTip(tip, replace, tipMatch);
  }
}

  
/***********************  Irregardless API Interface  **************************/

var Irregardless = new function() {
  var self = this,
      HOST = "https://api.irregardless.ly/api/v1",
      API_KEY = "3tkaamd9zazzwa27z4x6xmns",
      MATCH_ENDPOINT = HOST + "/rules/match?api_key=" + API_KEY,
      GUIDES_ENDPOINT = HOST + "/style_guides?recommended=true&api_key=" + API_KEY,
      GUIDES_QUERY_ENDPOINT = HOST + "/style_guides?api_key=" + API_KEY;
      
  this.selectedGuideId = 1;
  this.guides = [];
  this.isAutoRunEnabled = false;
  
  this.fetchTips = function() {
    SideBar.clearTips();
    SideBar.showLoading();

    google.script.run.withSuccessHandler(function(resp) {
      SideBar.showTips(resp.fullText, resp.tips);
    }).withFailureHandler(function(msg, err) { 
      SideBar.showError(); 
    }).fetchTips(this.selectedGuideId);
  };
  
  
   this.fetchGuides = function(query) {
     SideBar.showLoadingGuides();
     google.script.run.withSuccessHandler(function(resp) {
       if (self.guides.length == 0 && typeof query == 'undefined') {
         self.guides = resp; // initial population, we also add anything clicked on
       }
       SideBar.renderGuides(resp);
     }).withFailureHandler(function(msg, err) { 
       SideBar.showError(); 
     }).fetchGuides(query);
   };
   
   this.addGuide = function(guide) {
     if ($.inArray(guide.id, $.map(this.guides, function(g) { return g.id; })) < 0) {
       this.guides = this.guides.concat([guide]);
     }
   }
}




/***********************  Do the things  **************************/

$(function() {
  Irregardless.fetchTips();
  Irregardless.fetchGuides();
  
  var autoRun = function(){
    setTimeout(function(){
      if(Irregardless.isAutoRunEnabled){
        Irregardless.fetchTips();
      }
      autoRun();
    }, 30000);
  }
  
  autoRun();

  $(document).on("keyup", "#styleguide-query-input", function(evt){
    var $input = $(this)
    throttle(function(){
      Irregardless.fetchGuides($input.val());
    }, 1000 );
  });
  $(document).on("click", "[data-apply-tip]", function(evt){
    var tip = $(this).closest(".tip-container").data('tipObject');
    GoogleInterface.applyTip(tip, $(this).data('replacement'));
    evt.stopPropagation();
  });
  $(document).on("click", "[data-get-tips]", function(){
    Irregardless.fetchTips();
  });
  $(document).on("click", "[data-clear-highlights]", function(){
    GoogleInterface.removeHighlights();
  });
  $(document).on("click", "[data-toggle-sg-settings]", function(){
    SideBar.showSgSettings();
  });
  $(document).on("click", "[data-close-active-settings]", function(){
    SideBar.closeActiveSettings();
  });

  $(document).on("click", "#toggle-autorun", function(){
    Irregardless.isAutoRunEnabled = $(this).is(":checked");
  });

  $(document).on("click", "[data-save-guide-id]", function(){
    Irregardless.selectedGuideId = parseInt($(this).data("save-guide-id"));
    Irregardless.addGuide({id: Irregardless.selectedGuideId, name: $(this).data("save-guide-name")});
    SideBar.renderGuides();
    Irregardless.fetchTips();
  });
});

</script>
