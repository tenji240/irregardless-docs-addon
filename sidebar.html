<link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons.css">
<!-- The CSS package above applies Google styling to buttons and other elements. -->

<style>
  *:active, *:focus {
    outline: none;
  }
  .clearfix:before, .clearfix:after{
    content: " ";
    display: table;
  }
  .clearfix:after {
    clear: both
  }
  .muted {
    color: #6d6d6d;
  }
  .centered {
    text-align: center;
  }
  .float-left {
    float: left;
  }
  .float-right {
    float: right;
  }
  ul {
    text-align: left;
    padding-left: 20px;
    list-style: initial;
  }
  .unstyled {
    list-style: none;
    padding-left: 0;
    text-align: center;
  }
  .sidebar {
    padding: 0;
    position: static;
  }
  .autorun-checkbox {
    padding: 10px;
  }
  .actions {
    border-bottom: 1px solid #ddd;
    padding: 13px 11px;
    background: #fcfcfc;
    text-align: center;
    position: relative;
  }
  .clear-button {
    padding-left: 8px;
    display: inline-block;
  }
  .btn {
    display: inline-block;
    padding: 6px 12px;
    margin: 0 4px;
    text-align: center;
    white-space: nowrap;
    vertical-align: middle;
    cursor: pointer;
    border: 1px solid transparent;
    border-radius: 4px;
    text-decoration: none;
  }
  .btn:hover {
    text-decoration: none;
  }
  .btn-primary {
    background-color: #f26262;
    color: white;
  }
  .btn-secondary {
    border: 1px solid #d9d9d9;
    background-color: #fdfdfd;
    color: #f26262;
  }
  action-button:hover {
    text-decoration: none;
  }
  .arrow {
    font-size: 0.8em;
  }
  .settings-trigger {
    position: absolute;
    color: #666;
    font-size: 40px;
    padding-top: 4px;
    top: 12px;
    right: 10px;
  }
  .settings-trigger:hover {
    text-decoration: none;
  }
  .settings {
    margin-bottom: 12px;
    overflow: hidden;
    border-bottom: 1px solid #aaa;
    border-top: 1px solid #aaa;
    background: #f8f8f8;
    -moz-transition: all 0.5s ease;
    -webkit-transition: all 0.5s ease;
    -o-transition: all 0.5s ease;
    -ms-transition: all 0.5s ease;
    transition: all 0.5s ease;
    opacity: 0;
  }
  .settings.showing {
    opacity: 1;
  }
  .setting-separator {
    border: 1px solid #ccc;
    margin: 10px 0;
  }
  .styleguide-explanation {
    padding: 10px;
    color: #888;
  }
  .help-icon {
    display: inline-block;
    color: #777;
    font-weight: bold;
    padding: 0 4px;
    font-size: 14px;
    cursor: pointer;
  }
  .help-icon img {
    width: 15px;
  }
  #styleguide-query-input {
    margin: 10px;
    width: 92%;
    padding: 10px;
    height: 30px;
  }
  .styleguide-list {
    list-style: none;
    text-align: left;
    cursor: pointer;
    color: #6d6d6d;
    padding: 0;
    margin: 0;
  }
  .styleguide-list > li {
    position: relative;
    padding: 10px 20px 10px 10px;
    border-bottom: 1px solid #eee;
    -webkit-transform: translateZ(0);
    -webkit-backface-visibility: hidden;
  }
  .chosen-guide {
    background-color: #E56B6B;
    color: #f8f8f8;
  }
  .chosen-guide .check {
    position: absolute;
    right: 10px;
    top: 10px;
  }
  .styleguide-list > li:hover {
    background-color: #E56B6B;
    color: #f8f8f8;
  }
  .notice {
    display: none;
    margin: 0 auto;
    padding-top: 30px;
    text-align: center;
    font-size: 1.2em;
    color: #aaa;
  }
  #error {
    display: none;
  }
  #no-results {
    display: none;
  }
  .logo {
    vertical-align: middle;
  }
  .footer {
    position: absolute;
    height: 30px;
    width: 100%;
    bottom: 0;
    z-index: 2;
    background-color: #f8f8f8;
    padding: 2px 0;
    border-top: 1px solid #aaa;
    color: #777;
  }
  .footer a:hover {
    text-decoration: none;
  }
  .brand {
    color: #f26262;
  }
  .tips-container {
    z-index: 1;
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    padding-bottom: 35px;
    box-sizing: border-box;
    -moz-transition: all .5s ease;
    -webkit-transition: all .5s ease;
    -o-transition: all .5s ease;
    -ms-transition: all .5s ease;
    transition: all .5s ease;
  }
  .tips-container.hidden {
    margin-left: -100%;
  }
  .tip-container {
    position: relative;
    border-bottom: 1px solid #ccc;
    padding: 20px;
    background: #FDFAFA;
    -moz-box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -1px 0 rgba(0,0,0,.02);
    -webkit-box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -1px 0 rgba(0,0,0,.02);
    -o-box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -1px 0 rgba(0,0,0,.02);
    -ms-box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -1px 0 rgba(0,0,0,.02);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.4), inset 0 -1px 0 rgba(0,0,0,.02);
  }
  .tip-container:nth-child(even) {
    background: #fdfdfd;
  }
  .close-tip {
    color: #888;
    position: absolute;
    top: 2px;
    left: 2px;
    display: none;
  }
  .tip-container:hover .close-tip {
    display: block;
  }
  .tip-container:hover .tip-border {
    border: none;
  }
  .tip-border {
    position: absolute;
    left: 0;
    top: 0;
    width: 0;
    height: 0;
    margin-left: 0;
    border-style: solid;
    border-width: 10px 10px 0 0;
    border-color: #F26262 transparent transparent transparent;
  }
  .replacements {
    text-align:left;
  }
  .replacements-label {
    color: #F26262;
    display: inline-block;
    margin-bottom: 5px;
    text-transform: uppercase;
  }
  .replacements ul {
    color: #464141;
    list-style: none;
    padding-left: 0;
  }
  .replacements li {
    position: relative;
    padding-left: 10px;
  }
  .replacements li:before {
    position: absolute;
    left: 0;
    top: 0;
    content: "â€¢ ";
    color: #d1d1d1;
    -moz-box-shadow: 0 1px 0 rgba(255,255,255,.3);
    -webkit-box-shadow: 0 1px 0 rgba(255,255,255,.3);
    -o-box-shadow: 0 1px 0 rgba(255,255,255,.3);
    -ms-box-shadow: 0 1px 0 rgba(255,255,255,.3);
    box-shadow: 0 1px 0 rgba(255,255,255,.3);
  }
  .match-content {
    padding: 2px 0px;
    border-bottom: solid 2px #da2020;
    color: #da2020;
  }
  .text-snippet {
    padding-right: 50px;
    margin-bottom: 15px;
    text-align: left;
    color: #6F6E6E;
    min-height: 35px;
    font-size: 14px;
  }
  .explanation {
    text-align: left;
    padding: 10px;
    background: white;
    margin-top: 10px;
    color: #776D6D;
    border: 1px dotted #ccc;
    -moz-border-radius: 4px;
    -webkit-border-radius: 4px;
    border-radius: 4px;
  }
  .tips-list {
    position: relative;
    z-index: 1;
    margin-top: 0;
    margin-bottom: 0;
  }
  .match-string {
    font-weight: bold;
  }
  .tip {
  }
  .creator {
    position: absolute;
    width: 40px;
    right: 0;
    top: 0;
    padding: 0;
  }
  .creator img {
    width: 35px;
    height: 35px;
    -moz-box-shadow: -1px 1px 1px rgba(0 , 0 , 0 , 0.3);
    -webkit-box-shadow: -1px 1px 1px rgba(0 , 0 , 0 , 0.3);
    -o-box-shadow: -1px 1px 1px rgba(0 , 0 , 0 , 0.3);
    -ms-box-shadow: -1px 1px 1px rgba(0 , 0 , 0 , 0.3);
    box-shadow: -1px 1px 1px rgba(0 , 0 , 0 , 0.3);
  }
  .creator p {
    margin: 0;
    text-align: center;
  }
  
  /*
  Tipr 1.0.1
  Copyright (c) 2013 Tipue
  Tipr is released under the MIT License
  http://www.tipue.com/tipr
*/
  
  
  .tipr_content
  {
       font: 13px/1.7 'Helvetica Neue', Helvetica, Arial, sans-serif;
       color: #333; 
       background-color: #fff;
       color: #333;
       padding: 9px 17px;
  }
  .tipr_container_bottom
  {
       display: none;
       position: absolute;
       margin-top: 13px;
       z-index: 1000;
  }
  .tipr_container_top
  {
       display: none;
       position: absolute;
       margin-top: -75px;
       z-index: 1000;
  }
  .tipr_point_top, .tipr_point_bottom 
  {
       position: relative;
      background: #fff;
      border: 1px solid #dcdcdc;
  }
  .tipr_point_top:after, .tipr_point_top:before
  {
      position: absolute;
      pointer-events: none;
      border: solid transparent;
      top: 100%;
      content: "";
      height: 0;
      width: 0;
  }
  .tipr_point_top:after
  {
      border-top-color: #fff;
      border-width: 8px;
      left: 50%;
      margin-left: -8px;
  }
  .tipr_point_top:before 
  {
      border-top-color: #dcdcdc;
      border-width: 9px;
      left: 50%;
      margin-left: -9px;
  }
  .tipr_point_bottom:after, .tipr_point_bottom:before
  {
      position: absolute;
      pointer-events: none;
      border: solid transparent;
      bottom: 100%;
      content: "";
      height: 0;
      width: 0;
  }
  .tipr_point_bottom:after
  {
      border-bottom-color: #fff;
      border-width: 8px;
      left: 50%;
      margin-left: -8px;
  }
  .tipr_point_bottom:before 
  {
      border-bottom-color: #dcdcdc;
      border-width: 9px;
      left: 50%;
      margin-left: -9px;
  }
</style>

<div class="addon">
  <div class="sidebar">
    <div class="tips-container">
      <div class="actions clearfix">
        <a href="javascript://" class="btn btn-primary" data-get-tips>Get Tips</a>
        <a href="javascript://" class="btn btn-secondary clear-button" data-clear-highlights>Clear</a>
        <a id="settings-trigger" class="settings-trigger" data-toggle-settings>
          &#x2699;
        </a>
      </div>
      <div id="notice" class="notice">
      </div>
      <ul class="tips-list unstyled">
      </ul>
    </div>     
    <div class="settings">
      <div class="actions">
        <a href="javascript://" class="btn btn-primary" data-save-settings>Save</a>
        <a href="javascript://" class="btn btn-secondary" data-close-settings>Close</a>
      </div>
      <div class="autorun-checkbox">
        <input type="checkbox" id="toggle-autorun" name="autorun"/> <label for="autorun">Enable Auto-run</label>
        <div class="help-icon" data-tool-tip="With autorun, Irregardless.ly will automatically check your writing every 30 seconds.">
          <img src="http://irregardless.ly/assets/questionmark-in-circle-icon.png"/>
        </div>
      </div>
      <div class="setting-separator"></div>
      <div class="styleguide-settings">
        <div class="styleguide-explanation">
          Choose a style guide to test your writing against.
        </div>
        <div class="styleguide-search">
          <input type="text" id="styleguide-query-input" placeholder="Search for a styleguide" />
        </div>
        <ul class="unstyled styleguide-list">
        </ul>
      </div>
    </div>
    <div class="footer">
      <a href="http://irregardless.ly" target="_blank">
        <img alt="Add-on logo" class="logo" width="27" height="27" src="http://irregardless.ly/assets/favicon.png" />
        Writing tips by <span class="brand">Irregardless.ly</span>
      </a>
    </div>
  </div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js">
</script>

<script>

/***********************  Global Helpers  **************************/
var throttle = (function(){
  var timer = 0;
  return function(callback, ms){
    clearTimeout (timer);
    timer = setTimeout(callback, ms);
  };
})();


/***********************  Tip Rendering  **************************/

var Tip = function(tip, fullText) { 
  tip.text_snippet = this.prepareSnippet(fullText, tip);
  this.tip = tip; 
};
//either build an <ul> or return Don't use
Tip.prototype.replacementHtml = function (){
  var html = "<div class=\"replacements\">";
  if(this.tip.replacements && this.tip.replacements.length){
    html += "<div class=\"muted replacements-label\">Replace it with:</div><ul>";
    for(var i=0; i < this.tip.replacements.length; i++){
      html += "<li>" + " <a title=\"Click to apply\" href=\"javascript://\" data-replacement=\"" + this.tip.replacements[i] + "\" data-apply-tip>" + this.tip.replacements[i] + "</a>" + "</li>";
    }
    html += "</ul>";
  } else {
    html += " <a title=\"Click to delete\" href=\"javascript://\" data-replacement='' data-apply-tip>" + "Don't Use" + "</a>";
  }
  return html + "</div>";
}

Tip.prototype.linkify = function (string) {
  var urlRegex = /(https?:\/\/[^\s]+)/g;
  if(!string) return;
  return string.replace(urlRegex, function(url) {
    return '<a target="_blank" href="' + url + '">' + url + '</a>';
  });
}

Tip.prototype.truncate = function (string, length){
  if(string.length <= length) return string;
  else return string.substring(0, length) + "...";
}

Tip.prototype.render = function (){
  var beginning = "<li id='tip-" + this.tip.id + "' class=\"tip-container\" data-tip-container>"+
    "<div class=\"creator\">"+
      "<a href='http://irregardless.ly/#!/profile/" + this.tip.creator.id + "' target='_blank'>"+
        "<img src=\""+ this.tip.creator.mugshot_url+"\" title=\""+ this.tip.creator.name.split(' ')[0] + "\" alt=\""+ this.tip.creator.name.split(' ')[0] + "\" />"+
      "</a>"+
    "</div>"+
    "<div class=\"text-snippet\">"+
      this.tip.text_snippet + "<a href=\"javascript://\" data-find-tip> Find</a>" +
    "</div>"+
    "<div class=\"tip clearfix\">"+
      this.replacementHtml() +
      "<div class=\"explanation\">"+
        this.linkify(this.truncate(this.tip.explanation, 230)) +
        "<a href=\"http://irregardless.ly/#!/tip/" + this.tip.id + "\" target=\"_blank\" class=\"more-link\"> more</a>" +
      "</div>" +
      "<div class='tip-border'><a href='javascript://' data-tip-id='" + this.tip.id + "' class='close-tip'>X</a></div>";

    var end = "</div>"+
        "</li>";
    var $el = $(beginning + end);
    $el.data('tipObject', this.tip);
  return $el;
}

var regexQuote = function(str) {
    return (str+'').replace(/([.?*+^$[\]\\(){}|-])/g, "\\$1");
};

Tip.prototype.prepareSnippet = function(fullText, tip){
  //match will either be in the tip's `match_string`,
  //or the tips `matched_string`
  var regex = new RegExp("(\\s|\\b)" + regexQuote(tip.matched_string) + "(\\s|\\b)", 'ig')
    , snippet
    , indexOfM;
  //if text is short, snippet is the text
  if(fullText.length < 100) {
    snippet = fullText;
  } else {
    indexOfM = regex.exec(fullText).index
    //match is in the first 50 characters
    if(indexOfM < 50){
      snippet = fullText.slice(0, 100) + "...";
    //match is in the last 50 characters
    } else if(fullText.length - indexOfM < 50) {
      snippet = fullText.slice(fullText.length - 100, fullText.length);
    //match is somewhere in the middle
    } else {
     snippet = fullText.slice(indexOfM - 40, indexOfM + 40) + "...";
    }
  }
  return snippet.replace(regex, " <span class=\"match-content\">" + tip.matched_string +"</span> ");
}


/***********************  Sidebar control functions  **************************/

var SideBarObj = function() {
   var $notice = $("#notice"),
        $tipsList = $('.tips-list'),
        $styleGuideList = $(".styleguide-list"),
        $settings = $('.settings'),
        $settingsTrigger = $("#settings-trigger"),
        $autoRunCheckBox = $("#toggle-autorun"),
        $tipsCon = $('.tips-container');
 
   // Could be further extracted
   this.renderGuides = function(guides) {
     var guides = guides || Irregardless.guides,
         chosenGuideHtml;
     $styleGuideList.empty();
     if(guides.length) {
       for(var i=0; i<guides.length; i++){
         var guide = guides[i],
             html;
         if(guide.id === Irregardless.selectedGuideId){
           chosenGuideHtml = "<li class=\"chosen-guide\" data-save-guide-name=\"" + guide.name + "\" data-save-guide-id=" +
                      guide.id + " data-toggle-settings ><span class=\"check\">&#x2713;</span> " +
                      guide.name +
                    "</li>";
           $styleGuideList.append(chosenGuideHtml);
         } else {
           html = "<li data-save-guide-id=" + guide.id + " data-save-guide-name=\"" + guide.name + "\" data-toggle-settings>" +  guide.name + "</li>";
           $styleGuideList.append(html);
         }
       }
     } else {
       $styleGuideList.append("<li class='muted centered'> No results...</li>");
     }
   }
   
   
   this.showTips = function(fullText, tips){
     $notice.hide();
     if(tips.length) {
       for (var i = 0; i < tips.length; i++) {
         var tip = tips[i];
         GoogleInterface.highlight(tip);
         //`tip` is immuteable, make a muteable copy to add
         //the property `text_snippet` to
         var _tip = JSON.parse(JSON.stringify(tip));
         var html = new Tip(_tip, fullText).render();
         $tipsList.append(html);
      }
    } else {
      this.showNoResults()
    }
  }
  
  this.closeSettings = function(){
    $settings.removeClass('showing');
    $tipsCon.removeClass('hidden');
  }
  
  this.showSettings = function() {
    $tipsCon.addClass('hidden');
    $autoRunCheckBox.prop('checked', Irregardless.isAutoRunEnabled);
    setTimeout(function(){
      $settings.addClass('showing');
    }, 100);
  }
  
  this.clearTips = function() {
    $tipsList.empty();
  }
  
  this.showLoading = function () {
    $notice.html("<img src='http://irregardless.ly/assets/spinner.gif' />").show();
  }
  
  this.showLoadingGuides = function () {
    $styleGuideList.empty();
    $styleGuideList.append("<li><div class=\"centered\"><img src='http://irregardless.ly/assets/spinner.gif' /></div></li>");
  }

  this.showNoResults = function(){
    $notice.html("No results. <br /> Your writing looks good!").show();
  }

  this.showError = function(){
    $(".tips-list").empty();
    $notice.html("Oops! Something went wrong.<br />Please refresh and try again").show();
  }

  this.showNoText = function (){
    $notice.html("Looks like you don't have any writing in your document.").show();
  }
  
  this.showInstructions = function (){
    $notice.html("Click 'Get Tips' to check your writing.").show();
  }
}

var SideBar;
$(function() { SideBar = new SideBarObj(); }); // Init on DOM ready

    
var GoogleInterface = new function() {
  var noOp = function() {};
  var matches;
  var lastScrollTip;
  
  this.matchForTip = function(tip) {
    return $.grep(matches, function(match) { return match.text == tip.matched_string; })[0];
  }
  
  this.highlight = function(tip) {
    matches = [];
    google.script.run
        .withSuccessHandler(function(highlightedMatches) { matches = matches.concat(highlightedMatches); })
        .withFailureHandler(
          function() {
            SideBar.showError();
          })
        .highlight(tip);
  }
   
  this.removeHighlights = function () {
    google.script.run
        .withSuccessHandler(function() { lastScrollTip = null; })
        .withFailureHandler(
          function() { SideBar.showError(); })
        .unHighlight(matches);
  }

  this.applyTip = function(tip, replace) {
    var self = this
      , tipMatch = this.matchForTip(tip);
    google.script.run
        .withSuccessHandler(
          function() {
            //matches = $.grep(matches, function(match) { return match.text != tip.matched_string; });
            self.highlight(tip);
          })
        .withFailureHandler(
          function() {
            SideBar.showError();
          })
        .applyTip(tip, replace, tipMatch);
  }
  
  this.scrollToTip = function(tip) {
    google.script.run
        .withSuccessHandler(function(){
          lastScrollTip = tip;
        })
        .withFailureHandler(noOp)
        .scrollToTip(tip, lastScrollTip);
  }
}

  
/***********************  Irregardless API Interface  **************************/

var Irregardless = new function() {
  var self = this,
      HOST = "https://api.irregardless.ly/api/v1",
      API_KEY = "3tkaamd9zazzwa27z4x6xmns",
      MATCH_ENDPOINT = HOST + "/rules/match?api_key=" + API_KEY,
      GUIDES_ENDPOINT = HOST + "/style_guides?recommended=true&api_key=" + API_KEY,
      GUIDES_QUERY_ENDPOINT = HOST + "/style_guides?api_key=" + API_KEY;
      
  this.selectedGuideId = 11;
  this.guides = [];
  this.isAutoRunEnabled = false;
  
  this.fetchTips = function() {
    SideBar.clearTips();
    SideBar.showLoading();

    google.script.run.withSuccessHandler(function(resp) {
      SideBar.showTips(resp.fullText, resp.tips);
    }).withFailureHandler(function(msg, err) { 
      SideBar.showError(); 
    }).fetchTips(this.selectedGuideId);
  };
  
  
   this.fetchGuides = function(query) {
     SideBar.showLoadingGuides();
     google.script.run.withSuccessHandler(function(resp) {
       if (self.guides.length == 0 && typeof query == 'undefined') {
         self.guides = resp; // initial population, we also add anything clicked on
       }
       SideBar.renderGuides(resp);
     }).withFailureHandler(function(msg, err) { 
       SideBar.showError(); 
     }).fetchGuides(query);
   };
   
   this.addGuide = function(guide) {
     if ($.inArray(guide.id, $.map(this.guides, function(g) { return g.id; })) < 0) {
       this.guides = this.guides.concat([guide]);
     }
   }
}




/***********************  Do the things  **************************/

$(function() {
  Irregardless.fetchTips();
  Irregardless.fetchGuides();
  
  var autoRun = function(){
    setTimeout(function(){
      if(Irregardless.isAutoRunEnabled){
        Irregardless.fetchTips();
      }
      autoRun();
    }, 30000);
  }
  
  autoRun();
  
  $("[data-tool-tip]").tipr();

  $(document).on("keyup", "#styleguide-query-input", function(evt){
    var $input = $(this)
    throttle(function(){
      Irregardless.fetchGuides($input.val());
    }, 1000 );
  });
  $(document).on("click", "[data-apply-tip]", function(evt){
    var tip = $(this).closest(".tip-container").data('tipObject');
    GoogleInterface.applyTip(tip, $(this).data('replacement'), GoogleInterface.matchForTip(tip));
    evt.stopPropagation();
  });
  $(document).on("click", "[data-get-tips]", function(){
    Irregardless.fetchTips();
  });
  $(document).on("click", "[data-clear-highlights]", function(){
    GoogleInterface.removeHighlights();
    SideBar.clearTips();
    SideBar.showInstructions();
  });
  $(document).on("click", "[data-toggle-settings]", function(){
    SideBar.showSettings();
  });
  $(document).on("click", ".close-tip", function(){
    $('#tip-' + $(this).data('tip-id')).remove();
  });
  $(document).on("click", "[data-close-settings]", function(){
    SideBar.closeSettings();
  });
  $(document).on("click", "[data-save-settings]", function(){
    SideBar.closeSettings();
    GoogleInterface.removeHighlights();
    setTimeout(function() {
      Irregardless.fetchTips();
    }, 1500);
  });

  $(document).on("click", "#toggle-autorun", function(){
    Irregardless.isAutoRunEnabled = $(this).is(":checked");
  });
  
  $(document).on("click", "[data-find-tip]", function(){
    var tip = $(this).closest("[data-tip-container]").data('tipObject');
    GoogleInterface.scrollToTip(tip);
  });

  $(document).on("click", "[data-save-guide-id]", function(){
    Irregardless.selectedGuideId = parseInt($(this).data("save-guide-id"));
    Irregardless.addGuide({id: Irregardless.selectedGuideId, name: $(this).data("save-guide-name")});
    SideBar.renderGuides();
    $("#styleguide-query-input").val('');
  });
});

/*
Tipr 1.0.1
Copyright (c) 2013 Tipue
Tipr is released under the MIT License
http://www.tipue.com/tipr
*/


(function($) {

   $.fn.tipr = function(options) {

        var set = $.extend( {

             'speed'        : 200,
             'mode'         : 'bottom'

        }, options);

        return this.each(function() {

             var tipr_cont = '.tipr_container_' + set.mode;

             $(this).hover(
                  function ()
                  {
                       var out = '<div class="tipr_container_' + set.mode + '"><div class="tipr_point_' + set.mode + '"><div class="tipr_content">' + $(this).attr('data-tool-tip') + '</div></div></div>';

                       $(this).append(out);

                       var w_t = $(tipr_cont).outerWidth();
                       var w_e = $(this).width();
                       var m_l = (w_e / 2) - (w_t / 2);

                       $(tipr_cont).css('margin-left', m_l + 'px');
                       $(this).removeAttr('title');
                       $(tipr_cont).fadeIn(set.speed);
                  },
                  function ()
                  {
                       $(tipr_cont).remove();
                  }
             );

        });
   };

})(jQuery);

</script>

